<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AMORA – Register</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

  <style>
    :root{--bg:#fafafa;--card:#fff;--text:#1a1a1a;--text-light:#6b7280;--accent:#e91e63;--accent-hover:#c81c56;--border:#e5e7eb;--shadow:0 4px 12px rgba(0,0,0,.08);--radius:12px;--success:#10b981;--error:#ef4444;--success-bg:#ecfdf5;--error-bg:#fef2f2}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1.5rem}
    .container{background:var(--card);border-radius:var(--radius);padding:2.5rem 2rem;width:100%;max-width:420px;box-shadow:var(--shadow);text-align:center}
    .logo{width:72px;height:72px;margin:0 auto 1.25rem;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:1.75rem}
    h1{font-size:1.875rem;font-weight:600;margin-bottom:.5rem}
    .subtitle{font-size:.9375rem;color:var(--text-light);margin-bottom:2rem}
    .input-group{margin-bottom:1rem;text-align:left}
    label{display:block;font-size:.875rem;font-weight:500;margin-bottom:.5rem;color:#374151}
    input{width:100%;padding:.875rem 1rem;border:1.5px solid var(--border);border-radius:8px;font-size:1rem;transition:.2s}
    input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(233,30,99,.15)}
    .btn{width:100%;padding:.875rem;background:var(--accent);color:#fff;border:none;border-radius:8px;font-weight:500;cursor:pointer;margin-top:.5rem}
    .btn:hover{background:var(--accent-hover)}
    .btn-google{background:transparent;border:1.5px solid var(--border);color:#444;display:flex;align-items:center;justify-content:center;gap:.75rem}
    .divider{margin:1.75rem 0;position:relative;font-size:.875rem;color:var(--text-light)}
    .divider::before{content:'';position:absolute;top:50%;left:0;right:0;height:1px;background:var(--border)}
    .divider span{background:var(--card);padding:0 1rem}
    .links{margin-top:1.5rem;font-size:.875rem}
    .links a{color:var(--accent);text-decoration:none;font-weight:500}
    .links a:hover{text-decoration:underline}
    .message{margin:1rem 0;padding:.875rem 1rem;border-radius:8px;font-size:.875rem;font-weight:500;display:none;border:1px solid transparent}
    .success{background:var(--success-bg);color:var(--success);border-color:#a7f3d0}
    .error{background:var(--error-bg);color:var(--error);border-color:#fecaca}
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">A</div>
    <h1>AMORA</h1>
    <p class="subtitle">Create your account to get started.</p>

    <div class="input-group">
      <label for="email">Email Address</label>
      <input type="email" id="email" placeholder="you@example.com" required />
    </div>
    <div class="input-group">
      <label for="firstName">First Name</label>
      <input type="text" id="firstName" placeholder="John" required />
    </div>
    <div class="input-group">
      <label for="surname">Surname</label>
      <input type="text" id="surname" placeholder="Doe" required />
    </div>
    <div class="input-group">
      <label for="otherName">Other Name (Optional)</label>
      <input type="text" id="otherName" placeholder="Middle name" />
    </div>
    <div class="input-group">
      <label for="password">Password</label>
      <input type="password" id="password" placeholder="Min. 6 characters" required />
    </div>

    <div id="message" class="message"></div>

    <button id="registerBtn" class="btn">Create Account</button>

    <div class="divider"><span>or</span></div>
    <button id="googleRegister" class="btn btn-google">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
      Continue with Google
    </button>

    <div class="links">
      <a href="signin.html">Already have an account? Sign in</a>
    </div>
  </div>

  <script>
    // ==== Firebase Config ====
    const firebaseConfig = {
      apiKey: "AIzaSyBvrSpU_UsLdrwsG6h8OrQ2GinKZkP-nps",
      authDomain: "amora-bytales.firebaseapp.com",
      projectId: "amora-bytales",
      storageBucket: "amora-bytales.firebasestorage.app",
      messagingSenderId: "378090826699",
      appId: "1:378090826699:web:cf4cbd3f3b3afe65d5644e",
      measurementId: "G-PB6EX99N2Y",
      databaseURL: "https://amora-bytales-default-rtdb.firebaseio.com" // Add this!
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ==== DOM ====
    const $ = id => document.getElementById(id);
    const emailInp = $('email');
    const firstNameInp = $('firstName');
    const surnameInp = $('surname');
    const otherNameInp = $('otherName');
    const passInp = $('password');
    const registerBtn = $('registerBtn');
    const googleBtn = $('googleRegister');
    const msgBox = $('message');

    // ==== Helpers ====
    const showMsg = (txt, type = 'error') => {
      msgBox.textContent = txt;
      msgBox.className = `message ${type}`;
      msgBox.style.display = 'block';
      setTimeout(() => msgBox.style.display = 'none', 8000);
    };

    const goToHome = () => window.location.href = 'home.html';
    const goToSignIn = () => window.location.href = 'signin.html';

    // ==== Check Auth State (for verification redirect) ====
    auth.onAuthStateChanged(async user => {
      if (user) {
        if (user.emailVerified) {
          goToHome();
        } else {
          showMsg('Please verify your email. Check your inbox (and spam).', 'error');
        }
      }
    });

    // ==== Email/Password Registration ====
    registerBtn.addEventListener('click', async () => {
      const email = emailInp.value.trim();
      const pass = passInp.value;
      const firstName = firstNameInp.value.trim();
      const surname = surnameInp.value.trim();
      const otherName = otherNameInp.value.trim();

      if (!email || !pass || !firstName || !surname) {
        return showMsg('All required fields must be filled.');
      }
      if (pass.length < 6) {
        return showMsg('Password must be at least 6 characters.');
      }
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        return showMsg('Invalid email format.');
      }

      try {
        // Check if email already exists
        const methods = await auth.fetchSignInMethodsForEmail(email);
        if (methods.length > 0) {
          showMsg('This email is already registered. Please sign in.');
          setTimeout(goToSignIn, 2000);
          return;
        }

        // Create user
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        const user = cred.user;

        // Save profile to Realtime DB
        await db.ref('users/' + user.uid).set({
          email: user.email,
          firstName,
          surname,
          otherName: otherName || '',
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          emailVerified: false
        });

        // Send verification email
        await user.sendEmailVerification();
        showMsg('Account created! Please check your email to verify your account.', 'success');

      } catch (err) {
        if (err.code === 'auth/email-already-in-use') {
          showMsg('Email already in use. Try signing in.');
        } else if (err.code === 'auth/weak-password') {
          showMsg('Password is too weak.');
        } else {
          showMsg('Registration failed. Try again.');
        }
      }
    });

    // ==== Google Registration – Only if email NOT registered ====
    googleBtn.addEventListener('click', async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.addScope('email profile');

      try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        const email = user.email;

        // Check if this email is already in Firebase Auth
        const methods = await auth.fetchSignInMethodsForEmail(email);

        if (methods.length > 0) {
          // Email already exists → either link or block
          if (methods.includes('password') || methods.includes('google.com')) {
            showMsg('This Google account is already linked or registered. Sign in instead.');
            await auth.signOut();
            setTimeout(goToSignIn, 2000);
            return;
          }
        }

        // New Google user → save profile
        await db.ref('users/' + user.uid).set({
          email: user.email,
          firstName: user.displayName.split(' ')[0] || '',
          surname: user.displayName.split(' ').slice(1).join(' ') || '',
          otherName: '',
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          emailVerified: user.emailVerified
        });

        if (user.emailVerified) {
          goToHome();
        } else {
          showMsg('Google account linked. Verifying...', 'success');
        }

      } catch (err) {
        if (err.code === 'auth/popup-closed-by-user') return;
        if (err.code === 'auth/account-exists-with-different-credential') {
          showMsg('This email is already registered with another method. Sign in to link.');
          setTimeout(goToSignIn, 2000);
        } else {
          showMsg('Google registration failed.');
        }
      }
    });
  </script>
</body>
</html>