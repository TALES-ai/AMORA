<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AMORA â€“ Home</title>

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://www.gstatic.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    img-src 'self' data: https:;
    connect-src 'self' https://firestore.googleapis.com https://www.googleapis.com;
  ">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg: #fafafa;
      --card: #ffffff;
      --text: #1a1a1a;
      --accent: #e91e63;
      --accent-hover: #c81c56;
      --border: #e5e7eb;
      --shadow: 0 8px 25px rgba(0,0,0,0.1);
      --radius: 16px;
      --success: #10b981;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 1rem;
    }
    .header {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .logo {
      width: 60px; height: 60px; background: var(--accent); border-radius: 50%; margin: 0 auto 0.5rem;
      display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.5rem;
    }
    h1 { font-size: 1.5rem; font-weight: 600; }

    .card-stack {
      flex: 1;
      position: relative;
      max-width: 380px;
      margin: 0 auto;
      height: 520px;
    }
    .card {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: transform 0.4s ease, opacity 0.4s ease;
      user-select: none;
      display: flex;
      flex-direction: column;
    }
    .card img {
      width: 100%;
      height: 65%;
      object-fit: cover;
      background: #eee;
    }
    .card-info {
      padding: 1.25rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .name {
      font-size: 1.5rem;
      font-weight: 600;
    }
    .age { font-size: 1.1rem; color: #6b7280; }
    .bio { font-size: 0.9375rem; color: #4b5563; margin-top: 0.5rem; line-height: 1.5; }

    .actions {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    .btn {
      width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .btn-reject { background: #ef4444; }
    .btn-like { background: var(--success); }

    .empty {
      text-align: center;
      padding: 3rem 1rem;
      color: #6b7280;
      font-size: 1.1rem;
    }

    .logout {
      margin-top: 1.5rem;
      text-align: center;
      font-size: 0.875rem;
    }
    .logout a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="logo">A</div>
    <h1>Find Your Match</h1>
  </div>

  <div class="card-stack" id="cardStack">
    <div class="empty">Loading profiles...</div>
  </div>

  <div class="actions">
    <button class="btn btn-reject" id="rejectBtn">Close</button>
    <button class="btn btn-like" id="likeBtn">Heart</button>
  </div>

  <div class="logout">
    <a href="#" id="logoutLink">Sign Out</a>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBvrSpU_UsLdrwsG6h8OrQ2GinKZkP-nps",
      authDomain: "amora-bytales.firebaseapp.com",
      projectId: "amora-bytales",
      storageBucket: "amora-bytales.firebasestorage.app",
      messagingSenderId: "378090826699",
      appId: "1:378090826699:web:cf4cbd3f3b3afe65d5644e",
      measurementId: "G-PB6EX99N2Y"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const cardStack = document.getElementById('cardStack');
    const rejectBtn = document.getElementById('rejectBtn');
    const likeBtn = document.getElementById('likeBtn');
    const logoutLink = document.getElementById('logoutLink');

    let currentUser = null;
    let profiles = [];
    let currentIndex = 0;

    // === AUTH CHECK ===
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      currentUser = user;
      loadProfiles();
    });

    // === LOAD PROFILES (EXCEPT SELF) ===
    async function loadProfiles() {
      try {
        const snapshot = await db.collection('users').get();
        profiles = snapshot.docs
          .filter(doc => doc.id !== currentUser.uid)
          .map(doc => ({ id: doc.id, ...doc.data().personal }))
          .filter(p => p.firstName && p.lastName && p.dob);

        if (profiles.length === 0) {
          cardStack.innerHTML = '<div class="empty">No profiles available yet.</div>';
          return;
        }

        renderCard();
      } catch (err) {
        cardStack.innerHTML = '<div class="empty">Error loading profiles.</div>';
      }
    }

    // === RENDER CARD ===
    function renderCard() {
      if (currentIndex >= profiles.length) {
        cardStack.innerHTML = '<div class="empty">No more profiles!</div>';
        return;
      }

      const profile = profiles[currentIndex];
      const age = new Date().getFullYear() - new Date(profile.dob).getFullYear();

      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <img src="https://via.placeholder.com/380x300?text=${encodeURIComponent(profile.firstName)}" alt="Profile">
        <div class="card-info">
          <div>
            <div class="name">${profile.firstName} ${profile.lastName}</div>
            <div class="age">${age} years old</div>
            <div class="bio">${profile.phone || 'No bio yet.'}</div>
          </div>
        </div>
      `;

      cardStack.innerHTML = '';
      cardStack.appendChild(card);

      // === SWIPE LOGIC ===
      let startX = 0;
      let currentX = 0;
      let isDragging = false;

      const onStart = (e) => {
        isDragging = true;
        startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
        card.style.transition = 'none';
      };

      const onMove = (e) => {
        if (!isDragging) return;
        currentX = (e.type.includes('mouse') ? e.pageX : e.touches[0].pageX) - startX;
        card.style.transform = `translateX(${currentX}px) rotate(${currentX / 20}deg)`;
      };

      const onEnd = () => {
        if (!isDragging) return;
        isDragging = false;
        card.style.transition = 'transform 0.4s ease';

        const threshold = 100;
        if (Math.abs(currentX) > threshold) {
          const direction = currentX > 0 ? 1 : -1;
          card.style.transform = `translateX(${direction * 500}px) rotate(${direction * 30}deg)`;
          setTimeout(() => {
            if (direction === 1) handleLike();
            else handleReject();
          }, 300);
        } else {
          card.style.transform = 'translateX(0) rotate(0deg)';
        }
      };

      card.addEventListener('mousedown', onStart);
      card.addEventListener('mousemove', onMove);
      card.addEventListener('mouseup', onEnd);
      card.addEventListener('touchstart', onStart);
      card.addEventListener('touchmove', onMove);
      card.addEventListener('touchend', onEnd);
    }

    // === BUTTON ACTIONS ===
    rejectBtn.onclick = () => {
      const card = cardStack.querySelector('.card');
      if (card) {
        card.style.transition = 'transform 0.4s ease';
        card.style.transform = 'translateX(-500px) rotate(-30deg)';
        setTimeout(() => { currentIndex++; renderCard(); }, 400);
      }
    };

    likeBtn.onclick = () => {
      const card = cardStack.querySelector('.card');
      if (card) {
        card.style.transition = 'transform 0.4s ease';
        card.style.transform = 'translateX(500px) rotate(30deg)';
        setTimeout(() => { handleLike(); }, 400);
      }
    };

    async function handleLike() {
      const likedUserId = profiles[currentIndex].id;
      await db.collection('users').doc(currentUser.uid).collection('likes').doc(likedUserId).set({ timestamp: firebase.firestore.FieldValue.serverTimestamp() });
      currentIndex++;
      renderCard();
    }

    function handleReject() {
      currentIndex++;
      renderCard();
    }

    // === LOGOUT ===
    logoutLink.onclick = (e) => {
      e.preventDefault();
      auth.signOut().then(() => window.location.href = 'index.html');
    };
  </script>
</body>
</html>