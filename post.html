<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AMORA â€“ My Posts</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <style>
    :root{--bg:linear-gradient(135deg,#fdf2f8 0%,#fce7f3 100%);--card:#fff;--text:#1a1a1a;--light:#6b7280;--accent:#e91e63;--green:#10b981;--blue:#3b82f6;--radius:20px;--shadow:0 4px 20px rgba(233,30,99,.1);--border:#f3e8ff}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .header{background:var(--card);padding:1rem 1.5rem;box-shadow:0 2px 10px rgba(0,0,0,.05);position:fixed;top:0;left:0;right:0;z-index:100;display:flex;align-items:center;justify-content:space-between}
    .logo{width:60px;height:60px;border-radius:50%;object-fit:cover}
    .title{position:absolute;left:50%;transform:translateX(-50%);font-size:1.2rem;font-weight:600}
    .user-profile{display:flex;align-items:center;gap:.5rem;text-decoration:none;color:var(--text);font-weight:500;font-size:.9rem}
    .user-profile img{width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid var(--accent)}
    main{margin-top:90px;padding:1.5rem;padding-bottom:120px}
    .section{margin-bottom:1.5rem}
    .label{font-size:.8rem;color:var(--light);margin-bottom:.5rem;display:block;font-weight:500;text-transform:uppercase;letter-spacing:.5px}
    .label.required::after{content:' *';color:var(--accent)}
    .input, textarea{padding:.5rem 1rem;border:1px solid var(--border);border-radius:12px;width:100%;font-size:.95rem;background:#fafafa;transition:.2s}
    .input:focus, textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(233,30,99,.1)}
    .input:invalid, textarea:invalid{border-color:#ef4444}
    .input::placeholder, textarea::placeholder{font-style:italic;color:var(--light);opacity:1}
    textarea{resize:vertical;min-height:100px}
    .post-section{background:linear-gradient(135deg,rgba(16,185,129,.05) 0%,rgba(59,130,246,.05) 100%);padding:1rem;border-radius:var(--radius);border:1px solid var(--border)}
    .upload-btn{background:var(--accent);color:#fff;padding:.5rem 1rem;border:none;border-radius:var(--radius);font-weight:500;cursor:pointer;transition:.2s;display:inline-block;margin-top:.5rem}
    .upload-btn:hover{background:#c81c56;transform:translateY(-1px)}
    .btn{background:var(--accent);color:#fff;padding:.75rem;border:none;border-radius:var(--radius);font-weight:600;width:100%;cursor:pointer;margin-top:1rem;transition:.2s;position:relative;overflow:hidden}
    .btn:hover{background:#c81c56;transform:translateY(-1px)}
    .btn:disabled{background:#ccc;cursor:not-allowed;transform:none}
    .btn.saving::after{content:'';position:absolute;top:50%;left:50%;width:20px;height:20px;border:2px solid transparent;border-top:2px solid #fff;border-radius:50%;animation:spin 1s linear infinite;transform:translate(-50%,-50%)}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(360deg)}}
    .toast{position:fixed;top:20px;right:20px;padding:1rem 1.5rem;background:var(--accent);color:#fff;border-radius:var(--radius);box-shadow:var(--shadow);transform:translateX(100%);transition:.3s;z-index:200;min-width:250px}
    .toast.show{transform:translateX(0)}
    .toast.error{background:#ef4444}
    .nav{position:fixed;bottom:0;left:0;right:0;background:var(--card);display:flex;justify-content:space-around;padding:.75rem 0;box-shadow:0 -2px 10px rgba(0,0,0,.05);z-index:100}
    .nav a{display:flex;flex-direction:column;align-items:center;color:var(--light);text-decoration:none;font-size:.7rem;transition:.2s}
    .nav a.active{color:var(--accent)}
    .nav a:hover{transform:translateY(-2px)}
    .nav svg{width:24px;height:24px;margin-bottom:.25rem}
    .hidden{display:none}
    .divider{border-top:1px solid var(--border);margin:1.5rem 0}
    .other-options{display:flex;gap:1rem;margin-bottom:1rem}
    .other-options a{display:inline-block;background:var(--card);padding:.5rem 1.5rem;border:1px solid var(--border);border-radius:12px;text-decoration:none;color:var(--text);font-weight:500;font-size:.9rem;transition:.2s}
    .other-options a:hover{background:#f9fafb;transform:translateY(-1px)}
    .posts-grid{display:grid;grid-template-columns:1fr;gap:1rem}
    .post-card{background:var(--card);padding:1rem;border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow)}
    .post-header{display:flex;align-items:center;gap:.75rem;margin-bottom:.75rem}
    .post-user-pic{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid var(--accent)}
    .post-user-name{font-size:1rem;font-weight:600}
    .post-date{font-size:.8rem;color:var(--light)}
    .post-title{font-size:1.1rem;font-weight:600;margin-bottom:.5rem;text-transform:uppercase}
    .post-content{font-size:.95rem;margin-bottom:.75rem}
    .post-image{max-width:100%;border-radius:12px;margin-top:.5rem;display:block}
    @media (max-width: 768px) {
      .header{padding:1rem;gap:.5rem}
      main{padding:1rem;padding-bottom:100px}
      .other-options{flex-direction:column;gap:.5rem}
      .logo{width:50px;height:50px}
      .user-profile img{width:40px;height:40px}
    }
  </style>
</head>
<body>
  <header class="header">
    <img src="logo.jpg" alt="AMORA" class="logo">
    <div class="title">My Posts</div>
    <a href="profile.html" class="user-profile" id="userProfile">
      <img id="userPhoto" src="" alt="You">
    </a>
  </header>
  <main>
    <div class="other-options">
      <a href="profile.html">My Profile</a>
      <a href="interest.html">My Interests</a>
    </div>
    <div class="divider"></div>
    <div class="section post-section">
      <div class="label required">Post Title</div>
      <input type="text" class="input" id="postTitle" placeholder="Enter title (will be converted to uppercase)" required maxlength="50">
      <div class="label required">Post Description</div>
      <textarea class="input" id="postDescription" placeholder="Share your thoughts..." required maxlength="500"></textarea>
      <label class="upload-btn" for="postImage">Upload Image</label>
      <input type="file" id="postImage" accept="image/*" class="hidden">
    </div>
    <button class="btn hidden" id="saveBtn">Save Post</button>
    <div class="divider"></div>
    <div class="section">
      <div class="label">Your Posts</div>
      <div class="posts-grid" id="postsGrid"></div>
    </div>
    <div id="toast" class="toast hidden"></div>
  </main>
  <nav class="nav">
    <a href="home.html">
      <svg fill="currentColor" viewBox="0 0 20 20"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      <span>Home</span>
    </a>
    <a href="messages.html">
      <svg fill="currentColor" viewBox="0 0 20 20"><path d="M18 12.5v-6a2 2 0 00-2-2H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2z"/></svg>
      <span>Messages</span>
    </a>
    <a href="profile.html" class="active">
      <svg fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a4 4 0 100 8 4 4 0 000-8zM2 18a8 8 0 0116 0v-1a3 3 0 00-3-3H5a3 3 0 00-3 3v1z"/></svg>
      <span>Profile</span>
    </a>
  </nav>
  <script>
    const IMGBB_API_KEY = "049ece35b11b0e3e5c6dae6efde6dc20";
    const config = {
      apiKey: "AIzaSyBvrSpU_UsLdrwsG6h8OrQ2GinKZkP-nps",
      authDomain: "amora-bytales.firebaseapp.com",
      databaseURL: "https://amora-bytales-default-rtdb.firebaseio.com",
      projectId: "amora-bytales",
      storageBucket: "amora-bytales.firebasestorage.app",
      messagingSenderId: "378090826699",
      appId: "1:378090826699:web:cf4cbd3f3b3afe65d5644e"
    };
    firebase.initializeApp(config);
    const auth = firebase.auth();
    const db = firebase.database();
    const $ = id => document.getElementById(id);
    const postTitle = $('postTitle');
    const postDescription = $('postDescription');
    const postImage = $('postImage');
    const saveBtn = $('saveBtn');
    const toast = $('toast');
    const userPhoto = $('userPhoto');
    const postsGrid = $('postsGrid');
    let currentUser = null;
    let profileData = {};
    const MAX_POSTS = 10; // Max posts per user

    function showToast(message, isError = false) {
      toast.textContent = message;
      toast.classList.remove('hidden', 'show', 'error');
      if (isError) toast.classList.add('error');
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function checkForChanges() {
      const hasContent = postTitle.value.trim() || postDescription.value.trim() || postImage.files.length > 0;
      saveBtn.classList.toggle('hidden', !hasContent);
    }

    function formatDate(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true });
    }

    function renderPosts(posts) {
      postsGrid.innerHTML = posts.length ? posts.map(post => `
        <div class="post-card">
          <div class="post-header">
            <img src="${profileData.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(profileData.fullName || currentUser.email.split('@')[0])}&background=e91e63&color=fff&size=40`}" alt="User" class="post-user-pic">
            <div>
              <div class="post-user-name">${profileData.fullName || currentUser.email.split('@')[0]}</div>
              <div class="post-date">${formatDate(post.timestamp)}</div>
            </div>
          </div>
          <div class="post-title">${post.title}</div>
          <div class="post-content">${post.description}</div>
          ${post.image ? `<img src="${post.image}" alt="Post Image" class="post-image">` : ''}
        </div>
      `).join('') : '<p style="font-size:.9rem;color:var(--light);text-align:center;">No posts yet. Share something!</p>';
    }

    // Input listeners
    postTitle.addEventListener('input', () => {
      postTitle.value = postTitle.value.toUpperCase(); // Force uppercase
      checkForChanges();
    });
    postDescription.addEventListener('input', checkForChanges);
    postImage.addEventListener('change', checkForChanges);

    // AUTH STATE
    auth.onAuthStateChanged(async user => {
      if (!user) {
        showToast("Not logged in. Redirecting...", true);
        setTimeout(() => location.href = 'index.html', 1000);
        return;
      }
      currentUser = user;
      try {
        // Load user profile
        const userSnap = await db.ref('users/' + user.uid).once('value');
        profileData = userSnap.val() || {};
        profileData.fullName = [profileData.firstName, profileData.middleName, profileData.surname].filter(Boolean).join(' ') || user.email.split('@')[0];
        const picUrl = profileData.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(profileData.fullName)}&background=e91e63&color=fff&size=48`;
        userPhoto.src = picUrl;

        // Load posts and check limit
        db.ref('posts/' + user.uid).on('value', snap => {
          const postsData = snap.val() || {};
          const posts = Object.entries(postsData).map(([id, post]) => ({ id, ...post })).sort((a, b) => b.timestamp - a.timestamp);
          renderPosts(posts);
          if (posts.length >= MAX_POSTS) {
            saveBtn.disabled = true;
            saveBtn.classList.add('hidden');
            showToast("Maximum of 10 posts reached. Delete older posts to add new ones.", true);
          } else {
            saveBtn.disabled = false;
          }
        });

        showToast("Posts loaded. Share something new!");
      } catch (err) {
        showToast("Error loading data: " + err.message, true);
      }
    });

    // SAVE POST
    saveBtn.addEventListener('click', async () => {
      if (!currentUser) {
        showToast("Not logged in.", true);
        return;
      }
      const title = postTitle.value.trim();
      const description = postDescription.value.trim();
      if (!title || !description) {
        showToast("Please provide both a title and description.", true);
        return;
      }
      if (title.length > 50) {
        showToast("Title must be 50 characters or less.", true);
        return;
      }
      if (description.length > 500) {
        showToast("Description must be 500 characters or less.", true);
        return;
      }
      // Check post count
      try {
        const snap = await db.ref('posts/' + currentUser.uid).once('value');
        const postCount = snap.numChildren();
        if (postCount >= MAX_POSTS) {
          showToast("Maximum of 10 posts reached. Delete older posts to add new ones.", true);
          return;
        }
        saveBtn.textContent = '';
        saveBtn.classList.add('saving');
        saveBtn.disabled = true;
        let imageUrl = null;
        // Upload image if present
        if (postImage.files[0]) {
          showToast("Uploading image...");
          const file = postImage.files[0];
          const reader = new FileReader();
          reader.readAsDataURL(file);
          await new Promise(resolve => reader.onload = resolve);
          const base64 = reader.result.split(',')[1];
          const formData = new FormData();
          formData.append('key', IMGBB_API_KEY);
          formData.append('image', base64);
          const response = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });
          const result = await response.json();
          if (!result.success) {
            throw new Error(result.error?.message || "Image upload failed");
          }
          imageUrl = result.data.url;
        }
        // Save post to Firebase
        const postData = {
          title: title.toUpperCase(),
          description: description,
          image: imageUrl || null,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        await db.ref('posts/' + currentUser.uid).push(postData);
        showToast("Post saved successfully!");
        postTitle.value = '';
        postDescription.value = '';
        postImage.value = '';
        saveBtn.classList.add('hidden');
      } catch (err) {
        showToast("Save failed: " + err.message, true);
      } finally {
        saveBtn.textContent = 'Save Post';
        saveBtn.classList.remove('saving');
        saveBtn.disabled = false;
      }
    });
  </script>
</body>
</html>