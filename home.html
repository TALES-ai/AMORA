<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AMORA â€“ Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <style>
    :root{--bg:linear-gradient(135deg,#fdf2f8 0%,#fce7f3 100%);--card:#fff;--text:#1a1a1a;--light:#6b7280;--accent:#e91e63;--green:#10b981;--blue:#3b82f6;--radius:20px;--shadow:0 4px 20px rgba(233,30,99,.1);--border:#f3e8ff;--gold:#ffd700}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .header{background:var(--card);padding:1rem 1.5rem;box-shadow:0 2px 10px rgba(0,0,0,.05);position:fixed;top:0;left:0;right:0;z-index:100;display:flex;align-items:center;gap:1rem}
    .logo{width:48px;height:48px;border-radius:50%;object-fit:cover}
    .search{flex:1;padding:.75rem 1rem;border:1px solid var(--border);border-radius:var(--radius);background:#fafafa;font-size:.9rem;outline:none}
    .search:focus{border-color:var(--accent)}
    .user-profile{display:flex;align-items:center;gap:.5rem;text-decoration:none;color:var(--text);font-weight:500;font-size:.9rem}
    .user-profile img{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid var(--accent)}
    main{margin-top:80px;padding-bottom:100px}
    .section{margin:1.5rem}
    h2{font-size:1.2rem;font-weight:600;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
    .stories{display:flex;overflow-x:auto;gap:1rem;padding:1rem 0;scrollbar-width:none}
    .stories::-webkit-scrollbar{display:none}
    .story{flex:0 0 80px;text-align:center;cursor:pointer;transition:.2s;position:relative}
    .story img{width:70px;height:70px;border-radius:50%;border:3px solid var(--accent);margin-bottom:.5rem;object-fit:cover}
    .story .name{font-size:.8rem;font-weight:500}
    .story .location{font-size:.7rem;color:var(--light);margin-top:2px}
    .story.premium img{border-color:var(--gold)}
    .story.premium::after{content:'';position:absolute;top:0;right:0;width:16px;height:16px;background:var(--gold);border-radius:50%;border:2px solid var(--card)}
    .slider{display:flex;overflow-x:auto;gap:1rem;padding:1rem 0;scrollbar-width:none}
    .slider::-webkit-scrollbar{display:none}
    .slider-card{flex:0 0 100px;text-align:center;cursor:pointer;position:relative}
    .slider-card img{width:80px;height:80px;border-radius:50%;border:2px solid var(--border);margin-bottom:.5rem;object-fit:cover}
    .slider-card .name{font-size:.8rem;font-weight:500}
    .slider-card.premium img{border-color:var(--gold)}
    .slider-card.premium::after{content:'';position:absolute;top:0;right:0;width:16px;height:16px;background:var(--gold);border-radius:50%;border:2px solid var(--card)}
    .posts{display:flex;flex-direction:column;gap:1rem}
    .post-card{background:var(--card);border-radius:10px;box-shadow:var(--shadow);border:1px solid var(--border);position:relative}
    .post-header{display:flex;align-items:center;gap:.75rem;padding:1rem;position:relative}
    .post-header img{width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid var(--border)}
    .post-header .name{font-weight:600;font-size:1rem}
    .post-header.premium img{border-color:var(--gold)}
    .post-header.premium::after{content:'';position:absolute;top:1rem;left:4.5rem;width:16px;height:16px;background:var(--gold);border-radius:50%;border:2px solid var(--card)}
    .post-content img{width:100%;height:auto;object-fit:contain;border-radius:10px}
    .post-content .title{font-size:1.1rem;font-weight:600;padding:0 1rem;margin:.5rem 0}
    .post-content .description{font-size:.9rem;padding:0 1rem .5rem;color:var(--light);line-height:1.4}
    .post-actions{display:flex;justify-content:space-between;padding:0 1rem .75rem;align-items:center}
    .like-btn{display:flex;align-items:center;gap:.5rem;cursor:pointer;font-size:.9rem}
    .like-btn svg{width:24px;height:24px}
    .action-btn{font-size:.9rem;color:var(--accent);text-decoration:none;font-weight:500}
    .action-btn.follow{background:var(--green);color:#fff;padding:.25rem .75rem;border-radius:10px}
    .action-btn.follow.following{background:#ccc;color:#fff}
    .action-btn.message svg{width:24px;height:24px;fill:var(--accent)}
    .visit-profile{position:absolute;top:1rem;right:1rem;background:var(--accent);padding:.5rem;border-radius:50%;text-decoration:none;display:flex;align-items:center;justify-content:center;width:32px;height:32px}
    .visit-profile svg{width:20px;height:20px;fill:#fff}
    .add-post{position:fixed;bottom:80px;right:1rem;width:48px;height:48px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.2rem;box-shadow:0 2px 10px rgba(0,0,0,.2);z-index:99}
    .nav{position:fixed;bottom:0;left:0;right:0;background:var(--card);display:flex;justify-content:space-around;padding:.75rem 0;box-shadow:0 -2px 10px rgba(0,0,0,.05);z-index:100}
    .nav a{display:flex;flex-direction:column;align-items:center;color:var(--light);text-decoration:none;font-size:.7rem}
    .nav a.active{color:var(--accent)}
    .nav svg{width:24px;height:24px;margin-bottom:.25rem}
    .status{font-size:.85rem;color:var(--light);text-align:center;margin:1rem 0}
    .toast{position:fixed;top:20px;right:20px;padding:1rem 1.5rem;background:var(--accent);color:#fff;border-radius:var(--radius);box-shadow:var(--shadow);transform:translateX(100%);transition:.3s;z-index:200;min-width:250px}
    .toast.show{transform:translateX(0)}
    .toast.error{background:#ef4444}
    .hidden{display:none}
    @media (max-width: 768px) {
      .header{padding:1rem;gap:.75rem}
      .search{width:100px;padding:.5rem .75rem;font-size:.8rem}
      .logo{width:40px;height:40px}
      .user-profile img{width:36px;height:36px}
      .posts{gap:1.5rem}
      .post-header img{width:50px;height:50px}
      .post-content img{height:auto}
    }
  </style>
</head>
<body>
  <header class="header">
    <img src="logo.jpg" alt="AMORA" class="logo">
    <input type="search" class="search" placeholder="Search users..." id="search">
    <a href="profile.html" class="user-profile" id="userProfile">
      <img id="userPhoto" src="" alt="You">
    </a>
  </header>
  <main>
    <div class="status">New Profiles in AMORA</div>
    <section class="section">
      <h2>MOST RANKED PROFILES</h2>
      <div class="stories" id="stories"></div>
    </section>
    <section class="section">
      <h2>AMORA SUGGESTED PROFILES</h2>
      <div class="slider" id="recs"></div>
    </section>
    <section class="section">
      <h2>Explore Posts</h2>
      <div class="posts" id="posts"></div>
    </section>
    <div id="toast" class="toast hidden"></div>
    <a href="post.html" class="add-post">+</a>
  </main>
  <nav class="nav">
    <a href="home.html" class="active">
      <svg fill="currentColor" viewBox="0 0 20 20"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      <span>Home</span>
    </a>
    <a href="messages.html">
      <svg fill="currentColor" viewBox="0 0 20 20"><path d="M18 12.5v-6a2 2 0 00-2-2H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2z"/></svg>
      <span>Messages</span>
    </a>
    <a href="notifications.html">
      <svg fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/></svg>
      <span>Alerts</span>
    </a>
  </nav>
  <script>
    const config = {
      apiKey: "AIzaSyBvrSpU_UsLdrwsG6h8OrQ2GinKZkP-nps",
      authDomain: "amora-bytales.firebaseapp.com",
      databaseURL: "https://amora-bytales-default-rtdb.firebaseio.com",
      projectId: "amora-bytales",
      storageBucket: "amora-bytales.firebasestorage.app",
      messagingSenderId: "378090826699",
      appId: "1:378090826699:web:cf4cbd3f3b3afe65d5644e"
    };
    firebase.initializeApp(config);
    const auth = firebase.auth();
    const db = firebase.database();
    const $ = id => document.getElementById(id);
    const stories = $('stories');
    const recs = $('recs');
    const posts = $('posts');
    const searchInput = $('search');
    const userPhoto = $('userPhoto');
    const toast = $('toast');
    let allUsers = [];
    let currentUser = null;
    function showToast(message, isError = false) {
      toast.textContent = message;
      toast.classList.remove('hidden', 'show', 'error');
      if (isError) toast.classList.add('error');
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    function shufflePosts(posts) {
      const shuffled = [...posts].sort(() => Math.random() - 0.5);
      const result = [];
      const usedUids = new Set();
      for (const post of shuffled) {
        if (!usedUids.has(post.uid) || result.length === 0 || result[result.length - 1].uid !== post.uid) {
          result.push(post);
          usedUids.add(post.uid);
        }
      }
      return result;
    }
    async function toggleLike(postUid, postId, likeBtn) {
      try {
        const likeRef = db.ref(`posts/${postUid}/${postId}/likes/${currentUser.uid}`);
        const snap = await likeRef.once('value');
        if (snap.exists()) {
          try {
            await likeRef.remove();
            likeBtn.querySelector('svg').style.fill = 'none';
          } catch (err) {
            if (err.code !== 'PERMISSION_DENIED') {
              showToast('Error unliking post: ' + err.message, true);
            }
          }
        } else {
          await likeRef.set({ senderUid: currentUser.uid, timestamp: Date.now() });
          likeBtn.querySelector('svg').style.fill = 'red';
        }
        const likesSnap = await db.ref(`posts/${postUid}/${postId}/likes`).once('value');
        const count = likesSnap.val() ? Object.keys(likesSnap.val()).length : 0;
        likeBtn.querySelector('span').textContent = `${count} likes`;
      } catch (err) {
        if (err.code !== 'PERMISSION_DENIED') {
          showToast('Error liking post: ' + err.message, true);
        }
      }
    }
    async function toggleFollow(userUid, followBtn) {
      try {
        const followRef = db.ref(`followers/${userUid}/${currentUser.uid}`);
        const snap = await followRef.once('value');
        if (snap.exists()) {
          await followRef.remove();
          followBtn.textContent = 'Follow';
          followBtn.classList.remove('following');
        } else {
          await followRef.set({ followerUid: currentUser.uid, timestamp: Date.now() });
          followBtn.textContent = 'Following';
          followBtn.classList.add('following');
        }
      } catch (err) {
        showToast('Error following user: ' + err.message, true);
      }
    }
    async function renderContent() {
      try {
        const userSnap = await db.ref('users/' + currentUser.uid).once('value');
        const me = userSnap.val();
        console.log('Current user data:', me);
        if (!me || !me.gender) {
          showToast('Please update your gender to view posts.', true);
          setTimeout(() => location.href = 'profile.html', 1000);
          return;
        }
        const myGender = me.gender;
        console.log('Current user gender:', myGender);
        const usersSnap = await db.ref('users').once('value');
        allUsers = usersSnap.val() ? Object.entries(usersSnap.val()).map(([uid, u]) => ({ ...u, uid })) : [];
        const myName = `${me.firstName || ''} ${me.surname || ''}`.trim() || currentUser.email.split('@')[0];
        userPhoto.src = me.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(myName)}&background=e91e63&color=fff&size=40`;
        const others = allUsers.filter(u => u.uid !== currentUser.uid);
        stories.innerHTML = others.map(u => {
          const name = u.firstName || u.middleName || 'User';
          const location = u.residence ? `${u.residence}, ${u.country || ''}`.trim() : (u.country || u.nationality || '');
          const pic = u.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=e91e63&color=fff&size=70`;
          const premiumClass = u.accountType === 'premium' ? 'premium' : '';
          return `<div class="story ${premiumClass}" onclick="location.href='view.html?uid=${u.uid}'">
            <img src="${pic}" alt="${name}">
            <div class="name">${name}</div>
            <div class="location">${location || 'Not specified'}</div>
          </div>`;
        }).join('');
        let recsList = myGender === 'male' ? others.filter(u => u.gender === 'female') :
                       myGender === 'female' ? others.filter(u => u.gender === 'male') : others;
        recsList = recsList.sort(() => Math.random() - 0.5).slice(0, 6);
        recs.innerHTML = recsList.length ? recsList.map(u => {
          const name = u.firstName || u.middleName || 'User';
          const location = u.residence ? `${u.residence}, ${u.country || ''}`.trim() : (u.country || u.nationality || 'Not specified');
          const pic = u.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=e91e63&color=fff&size=80`;
          const premiumClass = u.accountType === 'premium' ? 'premium' : '';
          return `<div class="slider-card ${premiumClass}" onclick="location.href='view.html?uid=${u.uid}'">
            <img src="${pic}" alt="${name}">
            <div class="name">${name}</div>
          </div>`;
        }).join('') : '<p>No matches yet.</p>';
        const oppositeGender = myGender === 'male' ? 'female' : myGender === 'female' ? 'male' : null;
        if (!oppositeGender) {
          posts.innerHTML = '<p>Update your gender for personalized posts.</p>';
          return;
        }
        const targetUsers = allUsers.filter(u => u.gender === oppositeGender && u.uid !== currentUser.uid);
        console.log('Target users for posts:', targetUsers.map(u => u.uid));
        const allPosts = [];
        for (const user of targetUsers) {
          const postsSnap = await db.ref(`posts/${user.uid}`).once('value');
          const userPosts = postsSnap.val();
          if (userPosts) {
            Object.entries(userPosts).forEach(([postId, post]) => {
              if (post.timestamp > Date.now() - 7 * 24 * 60 * 60 * 1000) {
                allPosts.push({ ...post, uid: user.uid, postId });
              }
            });
          }
        }
        console.log('Fetched posts:', allPosts);
        const shuffledPosts = shufflePosts(allPosts);
        const postPromises = shuffledPosts.map(async post => {
          const user = allUsers.find(u => u.uid === post.uid);
          const name = [user?.firstName, user?.surname].filter(Boolean).join(' ') || 'User';
          const pic = user?.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=e91e63&color=fff&size=60`;
          const likesSnap = await db.ref(`posts/${post.uid}/${post.postId}/likes`).once('value');
          const likes = likesSnap.val() ? Object.keys(likesSnap.val()).length : 0;
          const isLiked = likesSnap.val()?.[currentUser.uid];
          const followSnap = await db.ref(`followers/${post.uid}/${currentUser.uid}`).once('value');
          const isFollowing = followSnap.exists();
          const premiumClass = user?.accountType === 'premium' ? 'premium' : '';
          return `
            <div class="post-card">
              <div class="post-header ${premiumClass}">
                <img src="${pic}" alt="${name}">
                <div class="name">${name}</div>
              </div>
              <div class="post-content">
                <div class="title">${post.title || 'Untitled'}</div>
                <img src="${post.image || 'https://via.placeholder.com/300'}" alt="${post.title}">
                <div class="description">${post.description || ''}</div>
              </div>
              <div class="post-actions">
                <div class="like-btn" onclick="toggleLike('${post.uid}', '${post.postId}', this)">
                  <svg viewBox="0 0 24 24" style="fill:${isLiked ? 'red' : 'none'};stroke:red;stroke-width:2">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                  </svg>
                  <span>${likes} likes</span>
                </div>
                <a href="messages.html?uid=${post.uid}" class="action-btn message">
                  <svg viewBox="0 0 24 24">
                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                  </svg>
                </a>
                <a href="#" class="action-btn follow${isFollowing ? ' following' : ''}" onclick="toggleFollow('${post.uid}', this)">${isFollowing ? 'Following' : 'Follow'}</a>
              </div>
              <a href="view.html?uid=${post.uid}" class="visit-profile">
                <svg fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 2a4 4 0 100 8 4 4 0 000-8zM2 18a8 8 0 0116 0v-1a3 3 0 00-3-3H5a3 3 0 00-3 3v1z"/>
                </svg>
              </a>
            </div>
          `;
        });
        posts.innerHTML = (await Promise.all(postPromises)).join('') || '<p>No posts yet. Check back later!</p>';
        searchInput.addEventListener('input', () => {
          const query = searchInput.value.toLowerCase().trim();
          const filteredUsers = allUsers.filter(u => {
            const name = `${u.firstName || ''} ${u.surname || ''} ${u.middleName || ''}`.toLowerCase();
            return name.includes(query) && u.uid !== currentUser.uid;
          });
          stories.innerHTML = filteredUsers.map(u => {
            const name = u.firstName || u.middleName || 'User';
            const location = u.residence ? `${u.residence}, ${u.country || ''}`.trim() : (u.country || u.nationality || '');
            const pic = u.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=e91e63&color=fff&size=70`;
            const premiumClass = u.accountType === 'premium' ? 'premium' : '';
            return `<div class="story ${premiumClass}" onclick="location.href='view.html?uid=${u.uid}'">
              <img src="${pic}" alt="${name}">
              <div class="name">${name}</div>
              <div class="location">${location || 'Not specified'}</div>
            </div>`;
          }).join('');
          recs.innerHTML = filteredUsers.filter(u => {
            return (myGender === 'male' && u.gender === 'female') || (myGender === 'female' && u.gender === 'male');
          }).sort(() => Math.random() - 0.5).slice(0, 6).map(u => {
            const name = u.firstName || u.middleName || 'User';
            const location = u.residence ? `${u.residence}, ${u.country || ''}`.trim() : (u.country || u.nationality || 'Not specified');
            const pic = u.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=e91e63&color=fff&size=80`;
            const premiumClass = u.accountType === 'premium' ? 'premium' : '';
            return `<div class="slider-card ${premiumClass}" onclick="location.href='view.html?uid=${u.uid}'">
              <img src="${pic}" alt="${name}">
              <div class="name">${name}</div>
            </div>`;
          }).join('');
        });
      } catch (err) {
        showToast('Error loading content: ' + err.message, true);
        console.error('Render error:', err);
      }
    }
    auth.onAuthStateChanged(user => {
      if (!user) {
        showToast('Not logged in. Redirecting...', true);
        setTimeout(() => location.href = 'index.html', 1000);
        return;
      }
      currentUser = user;
      renderContent();
    });
  </script>
</body>
</html>