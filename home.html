<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AMORA â€“ Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <style>
    :root{--bg:linear-gradient(135deg,#fdf2f8 0%,#fce7f3 100%);--card:#fff;--text:#1a1a1a;--light:#6b7280;--accent:#e91e63;--radius:20px;--shadow:0 4px 20px rgba(233,30,99,.1);--border:#f3e8ff}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .header{background:var(--card);padding:1rem 1.5rem;box-shadow:0 2px 10px rgba(0,0,0,.05);position:fixed;top:0;left:0;right:0;z-index:100;display:flex;align-items:center;gap:1rem}
    .logo{width:40px;height:40px;border-radius:50%;object-fit:cover}
    .search{flex:1;padding:.75rem 1rem;border:1px solid var(--border);border-radius:var(--radius);background:#fafafa;font-size:.9rem;outline:none}
    .search:focus{border-color:var(--accent)}
    .user-profile{display:flex;align-items:center;gap:.5rem;text-decoration:none;color:var(--text);font-weight:500;font-size:.9rem}
    .user-profile img{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--accent)}
    .post-btn{width:40px;height:40px;border-radius:50%;background:#f59e0b;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600;cursor:not-allowed;opacity:0.7}
    main{margin-top:70px;padding-bottom:80px}
    .section{margin:1.5rem}
    h2{font-size:1.2rem;font-weight:600;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
    .stories{display:flex;overflow-x:auto;gap:1rem;padding:1rem 0;scrollbar-width:none}
    .stories::-webkit-scrollbar{display:none}
    .story{flex:0 0 80px;text-align:center;cursor:pointer;transition:.2s}
    .story img{width:70px;height:70px;border-radius:50%;border:3px solid var(--accent);margin-bottom:.5rem;object-fit:cover}
    .story .name{font-size:.8rem;font-weight:500}
    .story .nationality{font-size:.7rem;color:var(--light);margin-top:2px}
    .recs{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem}
    .card{background:var(--card);border-radius:var(--radius);padding:1rem;text-align:center;cursor:pointer;box-shadow:var(--shadow);transition:.3s;border:1px solid var(--border)}
    .card:hover{transform:translateY(-5px);box-shadow:0 8px 30px rgba(233,30,99,.15);border-color:var(--accent)}
    .card img{width:80px;height:80px;border-radius:50%;margin-bottom:.75rem;object-fit:cover;border:2px solid var(--border)}
    .card .name{font-weight:600;font-size:1rem}
    .card .age{color:var(--light);font-size:.9rem;margin-top:.25rem}
    .nav{position:fixed;bottom:0;left:0;right:0;background:var(--card);display:flex;justify-content:space-around;padding:.75rem 0;box-shadow:0 -2px 10px rgba(0,0,0,.05);z-index:100}
    .nav a{display:flex;flex-direction:column;align-items:center;color:var(--light);text-decoration:none;font-size:.7rem}
    .nav a.active{color:var(--accent)}
    .nav svg{width:24px;height:24px;margin-bottom:.25rem}
    .status{font-size:.85rem;color:var(--light);text-align:center;margin:1rem 0}
    .premium-label{font-size:.7rem;background:#f59e0b;color:#fff;padding:2px 6px;border-radius:8px;font-weight:600}
  </style>
</head>
<body>
  <header class="header">
    <img src="logo.jpg" alt="AMORA" class="logo">
    <input type="search" class="search" placeholder="Search users..." id="search">
    <div class="post-btn" onclick="alert('Only Premium users can post!')" title="Premium Feature">+</div>
    <a href="profile.html" class="user-profile" id="userProfile">
      <img id="userPhoto" src="" alt="You">
      <span id="userName">You</span>
    </a>
  </header>

  <main>
    <div class="status">New Profiles in AMORA</div>

    <section class="section">
      <h2>Stories <span class="premium-label">Premium</span></h2>
      <div class="stories" id="stories"></div>
    </section>

    <section class="section">
      <h2>You may like</h2>
      <div class="recs" id="recs"></div>
    </section>
  </main>

  <nav class="nav">
    <a href="home.html" class="active">
      <svg fill="currentColor" viewBox="0 0 20 20"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      <span>Home</span>
    </a>
    <a href="messages.html">
      <svg fill="currentColor" viewBox="0 0 20 20"><path d="M18 12.5v-6a2 2 0 00-2-2H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2z"/></svg>
      <span>Messages</span>
    </a>
    <a href="notifications.html">
      <svg fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/></svg>
      <span>Alerts</span>
    </a>
  </nav>

  <script>
    const config = {
      apiKey: "AIzaSyBvrSpU_UsLdrwsG6h8OrQ2GinKZkP-nps",
      authDomain: "amora-bytales.firebaseapp.com",
      databaseURL: "https://amora-bytales-default-rtdb.firebaseio.com",
      projectId: "amora-bytales",
      storageBucket: "amora-bytales.firebasestorage.app",
      messagingSenderId: "378090826699",
      appId: "1:378090826699:web:cf4cbd3f3b3afe65d5644e"
    };

    firebase.initializeApp(config);
    const auth = firebase.auth();
    const db = firebase.database();

    const $ = id => document.getElementById(id);
    const stories = $('stories');
    const recs = $('recs');
    const searchInput = $('search');
    const userPhoto = $('userPhoto');
    const userName = $('userName');

    let allUsers = [];
    let currentUser = null;

    auth.onAuthStateChanged(async user => {
      if (!user) {
        setTimeout(() => location.href = 'index.html', 1000);
        return;
      }

      currentUser = user;

      try {
        const snap = await db.ref('users').once('value');
        const data = snap.val();
        if (!data) return;

        allUsers = Object.entries(data).map(([uid, u]) => ({ ...u, uid }));
        const others = allUsers.filter(u => u.uid !== user.uid);

        // === UPDATE TOP-RIGHT PROFILE ===
        const me = allUsers.find(u => u.uid === user.uid);
        const myName = `${me?.firstName || ''} ${me?.surname || ''}`.trim() || user.email.split('@')[0];
        userName.textContent = myName;
        userPhoto.src = me?.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(myName)}&background=e91e63&color=fff&size=36`;

        renderUsers(others);

        // Search
        searchInput.addEventListener('input', () => {
          const query = searchInput.value.toLowerCase().trim();
          const filtered = others.filter(u => {
            const name = `${u.firstName || ''} ${u.surname || ''} ${u.otherName || ''}`.toLowerCase();
            return name.includes(query);
          });
          renderUsers(filtered);
        });

      } catch (err) {
        console.error(err);
      }
    });

    function renderUsers(users) {
      if (users.length === 0) {
        stories.innerHTML = "<p>No users found.</p>";
        recs.innerHTML = "<p>No matches.</p>";
        return;
      }

      // STORIES: Show Nationality
      stories.innerHTML = users.map(u => {
        const name = u.firstName || u.otherName || 'User';
        const nationality = u.nationality ? ` (${u.nationality})` : '';
        const pic = u.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=e91e63&color=fff&size=70`;
        return `<div class="story" onclick="location.href='profile.html?uid=${u.uid}'">
          <img src="${pic}" alt="${name}">
          <div class="name">${name}</div>
          <div class="nationality">${nationality}</div>
        </div>`;
      }).join('');

      // RECOMMENDED
      const myGender = allUsers.find(u => u.uid === currentUser.uid)?.gender;
      const opposite = myGender === 'male' ? 'female' : myGender === 'female' ? 'male' : null;

      let recsList = users;
      if (opposite) {
        const opp = users.filter(u => u.gender === opposite);
        recsList = opp.length > 0 ? opp : users;
      }
      recsList = recsList.sort(() => Math.random() - 0.5).slice(0, 6);

      recs.innerHTML = recsList.map(u => {
        const name = u.firstName || u.otherName || 'User';
        const surname = u.surname ? ` ${u.surname[0]}.` : '';
        const age = u.birthYear ? new Date().getFullYear() - u.birthYear : '?';
        const pic = u.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=e91e63&color=fff&size=80`;
        return `<div class="card" onclick="location.href='profile.html?uid=${u.uid}'">
          <img src="${pic}" alt="${name}">
          <div class="name">${name}${surname}</div>
          <div class="age">${age} years old</div>
        </div>`;
      }).join('');
    }
  </script>
</body>
</html>