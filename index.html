<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AMORA – Sign In</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>

  <style>
    :root{--bg:#fafafa;--card:#fff;--text:#1a1a1a;--text-light:#6b7280;--accent:#e91e63;--accent-hover:#c81c56;--border:#e5e7eb;--shadow:0 4px 12px rgba(0,0,0,.08);--radius:12px;--success:#10b981;--error:#ef4444;--success-bg:#ecfdf5;--error-bg:#fef2f2}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1.5rem}
    .container{background:var(--card);border-radius:var(--radius);padding:2.5rem 2rem;width:100%;max-width:400px;box-shadow:var(--shadow);text-align:center}
    .logo{width:72px;height:72px;margin:0 auto 1.25rem;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:1.75rem}
    h1{font-size:1.875rem;font-weight:600;margin-bottom:.5rem}
    .subtitle{font-size:.9375rem;color:var(--text-light);margin-bottom:2rem}
    .input-group{margin-bottom:1rem;text-align:left}
    label{display:block;font-size:.875rem;font-weight:500;margin-bottom:.5rem;color:#374151}
    input{width:100%;padding:.875rem 1rem;border:1.5px solid var(--border);border-radius:8px;font-size:1rem;transition:.2s}
    input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(233,30,99,.15)}
    .btn{width:100%;padding:.875rem;background:var(--accent);color:#fff;border:none;border-radius:8px;font-weight:500;cursor:pointer;margin-top:.5rem}
    .btn:hover{background:var(--accent-hover)}
    .btn-google{background:transparent;border:1.5px solid var(--border);color:#444;display:flex;align-items:center;justify-content:center;gap:.75rem}
    .divider{margin:1.75rem 0;position:relative;font-size:.875rem;color:var(--text-light)}
    .divider::before{content:'';position:absolute;top:50%;left:0;right:0;height:1px;background:var(--border)}
    .divider span{background:var(--card);padding:0 1rem}
    .links{margin-top:1.5rem;font-size:.875rem;display:flex;justify-content:space-between;flex-wrap:wrap;gap:.5rem}
    .links a{color:var(--accent);text-decoration:none;font-weight:500}
    .links a:hover{text-decoration:underline}
    .message{margin:1rem 0;padding:.875rem 1rem;border-radius:8px;font-size:.875rem;font-weight:500;display:none;border:1px solid transparent}
    .success{background:var(--success-bg);color:var(--success);border-color:#a7f3d0}
    .error{background:var(--error-bg);color:var(--error);border-color:#fecaca}
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">A</div>
    <h1>AMORA</h1>
    <p class="subtitle">Welcome back. Sign in to continue.</p>

    <div class="input-group">
      <label for="email">Email Address</label>
      <input type="email" id="email" placeholder="you@example.com" autocomplete="email" required />
    </div>
    <div class="input-group">
      <label for="password">Password</label>
      <input type="password" id="password" placeholder="Enter your password" autocomplete="current-password" required />
    </div>

    <div id="message" class="message"></div>

    <button id="signInBtn" class="btn">Sign In</button>

    <div class="divider"><span>or</span></div>
    <button id="googleSignIn" class="btn btn-google">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
      Continue with Google
    </button>

    <div class="links">
      <a href="register.html">No account? Register</a>
      <a href="#" id="forgotPwd">Forgot password?</a>
    </div>
  </div>

<script>
  // ==== Firebase config ====
  const firebaseConfig = {
    apiKey: "AIzaSyBvrSpU_UsLdrwsG6h8OrQ2GinKZkP-nps",
    authDomain: "amora-bytales.firebaseapp.com",
    projectId: "amora-bytales",
    storageBucket: "amora-bytales.firebasestorage.app",
    messagingSenderId: "378090826699",
    appId: "1:378090826699:web:cf4cbd3f3b3afe65d5644e",
    measurementId: "G-PB6EX99N2Y"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  // ==== DOM ====
  const $ = id => document.getElementById(id);
  const emailInp   = $('email');
  const passInp    = $('password');
  const signInBtn  = $('signInBtn');
  const googleBtn  = $('googleSignIn');
  const forgotLink = $('forgotPwd');
  const msgBox     = $('message');

  // ==== Helpers ====
  const showMsg = (txt, type = 'error') => {
    msgBox.textContent = txt;
    msgBox.className = `message ${type}`;
    msgBox.style.display = 'block';
    setTimeout(() => msgBox.style.display = 'none', 8000);
  };

  const goToRegister = () => window.location.href = 'register.html';

  // ==== Auto-redirect only for already-signed-in users ====
  auth.onAuthStateChanged(user => {
    if (user) window.location.href = 'home.html';
  });

  // ==== Email/Password Sign-in ====
  signInBtn.addEventListener('click', async () => {
    const email = emailInp.value.trim();
    const pass  = passInp.value;

    if (!email || !pass) return showMsg('Enter email and password.');
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return showMsg('Invalid email format.');

    try {
      // First check if the email exists
      const methods = await auth.fetchSignInMethodsForEmail(email);
      if (methods.length === 0) {
        showMsg('This email is not registered. Please register first.', 'error');
        setTimeout(goToRegister, 2500);
        return;
      }

      // Email exists → try password
      await auth.signInWithEmailAndPassword(email, pass);
      // onAuthStateChanged will redirect
    } catch (err) {
      if (err.code === 'auth/wrong-password') {
        showMsg('Incorrect password. Please try again.');
      } else if (err.code === 'auth/too-many-requests') {
        showMsg('Too many failed attempts. Try again later.');
      } else {
        showMsg('Sign-in failed. Please try again.');
      }
    }
  });

  // ==== Google Sign-in – ONLY if user already exists ====
  googleBtn.addEventListener('click', async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.addScope('email profile');

    try {
      const result = await auth.signInWithPopup(provider);
      const user = result.user;

      // Check if this Google email is already in our auth system
      const methods = await auth.fetchSignInMethodsForEmail(user.email);
      if (methods.length === 0) {
        // User never signed up → sign them out + redirect to register
        await auth.signOut();
        showMsg('You must register with this Google account first.', 'error');
        setTimeout(goToRegister, 2500);
        return;
      }

      // User exists → proceed (onAuthStateChanged redirects)
    } catch (err) {
      if (err.code === 'auth/popup-closed-by-user') return;
      showMsg('Google sign-in failed. Please try again.');
    }
  });

  // ==== Forgot password ====
  forgotLink.addEventListener('click', async e => {
    e.preventDefault();
    const email = prompt('Enter your registered email:');
    if (!email) return;
    const em = email.trim();
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(em)) return showMsg('Invalid email.');

    try {
      const methods = await auth.fetchSignInMethodsForEmail(em);
      if (!methods.length) return showMsg('Email not registered. Please register first.', 'error');

      await auth.sendPasswordResetEmail(em);
      showMsg('Password reset link sent – check inbox/spam.', 'success');
    } catch (err) {
      showMsg('Failed to send reset link. Try again later.');
    }
  });
</script>
</body>
</html>